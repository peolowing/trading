import { useState, useEffect } from "react";
import EntryModal from "./EntryModal";
import { useAuth } from "../contexts/AuthContext";

export default function Dashboard({ onSelectStock, onNavigate, onOpenPosition }) {
  const { user, signOut } = useAuth();
  const [watchlist, setWatchlist] = useState([]);
  const [liveData, setLiveData] = useState({});
  const [refreshingLive, setRefreshingLive] = useState(false);
  const [portfolio, setPortfolio] = useState([]);
  const [screenerData, setScreenerData] = useState([]);
  const [screenerLoading, setScreenerLoading] = useState(false);
  const [customInput, setCustomInput] = useState("");
  const [showEntryModal, setShowEntryModal] = useState(false);
  const [selectedStock, setSelectedStock] = useState(null);
  const [showHelpModal, setShowHelpModal] = useState(false);
  const [expandedRow, setExpandedRow] = useState(null);

  useEffect(() => {
    loadWatchlist();
    loadPortfolio();
    loadScreener();
  }, []);

  // Status icon mapping
  function getStatusIcon(status) {
    switch(status) {
      case 'WAIT_PULLBACK': return 'üîµ';
      case 'APPROACHING': return 'üü°';
      case 'READY': return 'üü¢';
      case 'BREAKOUT_ONLY': return 'üü†';
      case 'INVALIDATED': return 'üî¥';
      default: return '‚ö™';
    }
  }

  function getStatusLabel(status) {
    switch(status) {
      case 'WAIT_PULLBACK': return 'V√§nta';
      case 'APPROACHING': return 'N√§rmar sig';
      case 'READY': return 'Klar';
      case 'BREAKOUT_ONLY': return 'Endast breakout';
      case 'INVALIDATED': return 'Ta bort';
      default: return 'Ok√§nd';
    }
  }

  async function loadWatchlist() {
    try {
      const res = await fetch("/api/watchlist");
      const data = await res.json();
      const stocks = data.stocks || [];

      // Debug: Log the received data
      console.log('Dashboard - Watchlist API response:', data);
      console.log('Dashboard - Stocks array:', stocks);
      stocks.forEach(stock => {
        console.log(`${stock.ticker}: edge_score=${stock.edge_score}, regime=${stock.regime}`);
      });

      setWatchlist(stocks);

      // Fetch live data for all watchlist stocks
      if (stocks.length > 0) {
        await fetchLiveData(stocks);
      }
    } catch (e) {
      console.error("Watchlist error:", e);
    }
  }

  async function fetchLiveData(stocks) {
    setRefreshingLive(true);
    try {
      const tickers = stocks.map(s => s.ticker).join(",");
      const res = await fetch(`/api/watchlist/live?tickers=${tickers}`);
      const data = await res.json();
      setLiveData(data.quotes || {});
    } catch (e) {
      console.error("Live data error:", e);
    } finally {
      setRefreshingLive(false);
    }
  }

  async function refreshLiveData() {
    if (watchlist.length > 0) {
      await fetchLiveData(watchlist);
    }
  }

  async function loadPortfolio() {
    try {
      const res = await fetch("/api/portfolio");
      const data = await res.json();
      setPortfolio(data.stocks || []);
    } catch (e) {
      console.error("Portfolio error:", e);
    }
  }

  async function loadScreener() {
    setScreenerLoading(true);
    try {
      const res = await fetch("/api/screener");
      const data = await res.json();
      setScreenerData(data.stocks || []);
    } catch (e) {
      console.error("Screener error:", e);
    } finally {
      setScreenerLoading(false);
    }
  }

  async function addToWatchlist(ticker, indicators = null) {
    try {
      const payload = { ticker };

      // If we have indicators from screener, include them for initial snapshot
      if (indicators) {
        payload.indicators = indicators;
      }

      await fetch("/api/watchlist", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      await loadWatchlist();
    } catch (e) {
      console.error("Add to watchlist error:", e);
    }
  }

  async function removeFromWatchlist(ticker) {
    try {
      await fetch(`/api/watchlist/${ticker}`, { method: "DELETE" });
      await loadWatchlist();
    } catch (e) {
      console.error("Remove from watchlist error:", e);
    }
  }

  async function prepareStockForEntry(item) {
    try {
      // Fetch full analysis with entry/stop/target recommendations
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ticker: item.ticker })
      });
      const data = await res.json();

      console.log('Analysis data for', item.ticker, ':', data);

      // Enrich item with analysis data
      const enriched = {
        ...item,
        // Recommended values
        recommended_entry: data.trade?.entry,
        recommended_stop: data.trade?.stop,
        recommended_target: data.trade?.target,
        recommended_rr: data.trade?.rr,
        // Current technical data
        current_price: data.trade?.entry || item.current_price,
        ema20: data.indicators?.ema20,
        ema50: data.indicators?.ema50,
        rsi: data.indicators?.rsi14,
        rsi_zone: data.indicators?.rsi_zone,
        volume_rel: data.indicators?.relativeVolume,
        edge_score: data.scoring?.total
      };

      console.log('Enriched stock:', enriched);
      return enriched;
    } catch (e) {
      console.error("Failed to fetch analysis:", e);
      return item; // Return original if fetch fails
    }
  }

  async function removeFromPortfolio(ticker) {
    try {
      await fetch(`/api/portfolio/${ticker}`, { method: "DELETE" });
      await loadPortfolio();
    } catch (e) {
      console.error("Remove from portfolio error:", e);
    }
  }

  async function handleAddToPortfolio(entryData) {
    try {
      const res = await fetch('/api/portfolio', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entryData)
      });

      if (res.ok) {
        // Close modal
        setShowEntryModal(false);
        setSelectedStock(null);

        // Refresh portfolio
        await loadPortfolio();

        // Optional: Navigate to Position Detail
        if (onOpenPosition) {
          onOpenPosition(entryData.ticker);
        }

        alert(`‚úÖ ${entryData.ticker} tillagd i portfolio!`);
      } else {
        const error = await res.json();
        alert(`‚ùå Kunde inte l√§gga till: ${error.error || 'Ok√§nt fel'}`);
      }
    } catch (e) {
      console.error('Add to portfolio error:', e);
      alert(`‚ùå Fel: ${e.message}`);
    }
  }

  async function handleSearch(e) {
    e.preventDefault();
    const ticker = customInput.trim().toUpperCase();
    if (!ticker) return;

    try {
      // Fetch stock data
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ticker })
      });

      if (!res.ok) {
        alert(`‚ùå Kunde inte hitta aktie: ${ticker}`);
        return;
      }

      const data = await res.json();
      const price = data.candles?.[data.candles.length - 1]?.close;
      const setup = data.indicators?.setup || 'N/A';
      const edgeScore = data.scoring?.score || 0;

      // Show confirmation dialog
      const confirm = window.confirm(
        `Vill du l√§gga till ${ticker} i bevakning?\n\n` +
        `Pris: ${price?.toFixed(2) || 'N/A'} kr\n` +
        `Setup: ${setup}\n` +
        `Edge Score: ${edgeScore.toFixed(0)}/100`
      );

      if (confirm) {
        await addToWatchlist(ticker, {
          price: price,
          ema20: data.indicators?.ema20,
          ema50: data.indicators?.ema50,
          rsi14: data.indicators?.rsi14,
          regime: data.indicators?.regime,
          setup: setup,
          relativeVolume: data.indicators?.relativeVolume
        });
        setCustomInput(''); // Clear search field
      }
    } catch (error) {
      console.error('Search error:', error);
      alert(`‚ùå Fel vid s√∂kning: ${error.message}`);
    }
  }

  return (
    <div className="container">
      <header className="header">
        <div>
          <p className="eyebrow">Veckotrading AI</p>
          <h1>üìà Dashboard</h1>
          {user && (
            <p style={{ fontSize: "12px", color: "#6b7280", marginTop: "4px" }}>
              {user.email}
            </p>
          )}
        </div>
        <div style={{ display: "flex", gap: "10px" }}>
          <button
            onClick={() => onNavigate("watchlist-live")}
            style={{
              padding: "10px 20px",
              background: "#10b981",
              color: "white",
              border: "none",
              borderRadius: "6px",
              fontSize: "14px",
              fontWeight: "600",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "8px"
            }}
          >
            üìä Live Watchlist
          </button>
          <button
            onClick={() => onNavigate("agents")}
            style={{
              padding: "10px 20px",
              background: "#3b82f6",
              color: "white",
              border: "none",
              borderRadius: "6px",
              fontSize: "14px",
              fontWeight: "600",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "8px"
            }}
          >
            ü§ñ Trading Agents
          </button>
          <button
            onClick={() => signOut()}
            style={{
              padding: "10px 20px",
              background: "#ef4444",
              color: "white",
              border: "none",
              borderRadius: "6px",
              fontSize: "14px",
              fontWeight: "600",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "8px"
            }}
          >
            üö™ Logga ut
          </button>
        </div>
      </header>


      {/* Portfolio - F√∂rvaltningslista */}
      {/* Portfolio - F√∂rvaltningslista */}
      <div className="card" style={{ marginBottom: "16px" }}>
        <div className="card-header" style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: "12px" }}>
          <div>
            <p className="eyebrow">F√∂rvaltningslista ‚Äì Exit Cockpit</p>
            <span className="tag">{portfolio.length} positioner</span>
          </div>
          <button
            onClick={() => onNavigate("closed-positions")}
            style={{
              padding: "6px 12px",
              background: "white",
              border: "1px solid #e2e8f0",
              borderRadius: "6px",
              fontSize: "13px",
              fontWeight: "500",
              color: "#64748b",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "4px"
            }}
          >
            üìö Avslutade aff√§rer
          </button>
        </div>

        {portfolio.length > 0 && (
          <div style={{ display: "flex", gap: "8px", marginBottom: "12px", fontSize: "11px", flexWrap: "wrap" }}>
            <span style={{ color: "#64748b" }}>üü¢ HOLD</span>
            <span style={{ color: "#64748b" }}>üü° TIGHTEN STOP</span>
            <span style={{ color: "#64748b" }}>üü† PARTIAL EXIT</span>
            <span style={{ color: "#64748b" }}>üî¥ EXIT</span>
            <span style={{ color: "#64748b" }}>‚ö´ STOP HIT</span>
          </div>
        )}

        {portfolio.length === 0 ? (
          <p style={{ color: "#64748b", textAlign: "center", padding: "20px" }}>
            Inga aktiepositioner √§nnu. L√§gg till fr√•n analysvyn.
          </p>
        ) : (
          <div style={{ overflowX: "auto" }}>
            <table style={{ width: "100%", fontSize: "13px", borderCollapse: "collapse" }}>
              <thead>
                <tr style={{ borderBottom: "2px solid #e2e8f0", color: "#64748b", fontSize: "11px", textTransform: "uppercase", letterSpacing: "0.05em" }}>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>Status</th>
                  <th style={{ padding: "8px 12px", textAlign: "left" }}>Aktie</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>Pris</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>Entry</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>PnL %</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>R</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>Stop</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>Target</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>Trailing</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>Dagar</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}></th>
                </tr>
              </thead>
              <tbody>
                {portfolio
                  .sort((a, b) => {
                    // Sort EXIT first, then STOP_HIT, then others
                    const statusPriority = {
                      'EXIT': 1,
                      'STOP_HIT': 2,
                      'PARTIAL_EXIT': 3,
                      'TIGHTEN_STOP': 4,
                      'HOLD': 5
                    };
                    const aPriority = statusPriority[a.current_status] || 99;
                    const bPriority = statusPriority[b.current_status] || 99;
                    return aPriority - bPriority;
                  })
                  .map((item) => {
                    const status = item.current_status || 'HOLD';

                    // Status icon
                    const statusIcon = status === 'HOLD' ? 'üü¢' :
                                      status === 'TIGHTEN_STOP' ? 'üü°' :
                                      status === 'PARTIAL_EXIT' ? 'üü†' :
                                      status === 'EXIT' ? 'üî¥' :
                                      status === 'STOP_HIT' ? '‚ö´' : '‚ö™';

                    // Row highlighting for EXIT/STOP_HIT
                    const isExit = status === 'EXIT' || status === 'STOP_HIT';
                    const rowBg = isExit ? "#fef2f2" : "transparent";
                    const rowBorder = isExit ? "2px solid #fca5a5" : "1px solid #f1f5f9";

                    // PnL color coding
                    const pnlPct = item.pnl_pct ?? 0;
                    const pnlColor = pnlPct >= 0 ? "#16a34a" : "#dc2626";

                    // R-multiple color coding
                    const rMultiple = item.r_multiple ?? 0;
                    let rColor = "#64748b";
                    if (rMultiple >= 2) rColor = "#16a34a"; // +2R = green
                    else if (rMultiple >= 1) rColor = "#3b82f6"; // +1R = blue
                    else if (rMultiple < 0) rColor = "#dc2626"; // negative = red

                    // Current price (fallback to entry if no current)
                    const currentPrice = item.current_price || item.entry_price;

                    return (
                      <tr
                        key={item.ticker}
                        style={{
                          borderBottom: rowBorder,
                          background: rowBg,
                          cursor: "pointer",
                          transition: "all 0.15s"
                        }}
                        onClick={() => onOpenPosition && onOpenPosition(item.ticker)}
                        onMouseEnter={(e) => {
                          if (!isExit) e.currentTarget.style.background = "#f8fafc";
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = rowBg;
                        }}
                      >
                        {/* Status Icon */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <span style={{ fontSize: "20px" }}>{statusIcon}</span>
                        </td>

                        {/* Aktie */}
                        <td style={{ padding: "10px 12px" }}>
                          <strong style={{ color: "#0f172a" }}>{item.ticker}</strong>
                        </td>

                        {/* Pris */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums" }}>
                          {currentPrice ? currentPrice.toFixed(2) : "‚Äî"}
                        </td>

                        {/* Entry */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums", color: "#64748b" }}>
                          {item.entry_price ? item.entry_price.toFixed(2) : "‚Äî"}
                        </td>

                        {/* PnL % */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontWeight: "700", color: pnlColor, fontVariantNumeric: "tabular-nums" }}>
                          {pnlPct !== null && pnlPct !== undefined ? `${pnlPct > 0 ? '+' : ''}${pnlPct.toFixed(1)}%` : "‚Äî"}
                        </td>

                        {/* R-multiple */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontWeight: "700", color: rColor, fontVariantNumeric: "tabular-nums" }}>
                          {rMultiple !== null && rMultiple !== undefined ? `${rMultiple > 0 ? '+' : ''}${rMultiple.toFixed(1)}R` : "‚Äî"}
                        </td>

                        {/* Stop */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums", color: "#64748b" }}>
                          {item.current_stop ? item.current_stop.toFixed(2) : item.initial_stop?.toFixed(2) || "‚Äî"}
                        </td>

                        {/* Target */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums", color: "#64748b" }}>
                          {item.initial_target ? item.initial_target.toFixed(2) : "‚Äî"}
                        </td>

                        {/* Trailing Type */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <span style={{
                            fontSize: "11px",
                            fontWeight: "600",
                            color: "#64748b",
                            background: "#f1f5f9",
                            padding: "2px 6px",
                            borderRadius: "4px"
                          }}>
                            {item.trailing_type || "EMA20"}
                          </span>
                        </td>

                        {/* Dagar */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <span style={{ fontSize: "12px", color: "#94a3b8", fontWeight: "500" }}>
                            {item.days_in_trade || 0}d
                          </span>
                        </td>

                        {/* Action Button */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <button
                            className="action-btn delete"
                            onClick={(e) => {
                              e.stopPropagation();
                              removeFromPortfolio(item.ticker);
                            }}
                            title="Ta bort fr√•n portf√∂lj"
                          >
                            ‚úï
                          </button>
                        </td>
                      </tr>
                    );
                  })
                }
              </tbody>
            </table>

            {/* Exit signal explanation row below table */}
            {portfolio.some(p => p.exit_signal) && (
              <div style={{ marginTop: "16px", fontSize: "12px", color: "#64748b" }}>
                <strong>Exit-signaler:</strong>
                <ul style={{ marginTop: "8px", paddingLeft: "20px" }}>
                  {portfolio.filter(p => p.exit_signal).map(p => (
                    <li key={p.ticker} style={{ marginBottom: "4px" }}>
                      <strong>{p.ticker}:</strong> {p.exit_signal}
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {/* Update info */}
            <div style={{ marginTop: "16px", fontSize: "12px", color: "#64748b" }}>
              <strong>Senaste uppdatering:</strong> K√∂r <code style={{ background: "#f1f5f9", padding: "2px 6px", borderRadius: "4px" }}>POST /api/portfolio/update</code> f√∂r daglig uppdatering
            </div>
          </div>
        )}
      </div>

      {/* Watchlist - Bevakningslista */}
      <div className="card" style={{ marginBottom: "16px" }}>
        <div className="card-header" style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div>
            <p className="eyebrow">Bevakningslista ‚Äì Radar</p>
            <span className="tag">{watchlist.length} aktier</span>
          </div>
          {watchlist.length > 0 && (
            <div style={{ display: "flex", gap: "8px" }}>
              <button
                onClick={refreshLiveData}
                disabled={refreshingLive}
                style={{
                  padding: "6px 12px",
                  background: "transparent",
                  color: refreshingLive ? "#9ca3af" : "#64748b",
                  border: `1px solid ${refreshingLive ? "#d1d5db" : "#e5e7eb"}`,
                  borderRadius: "6px",
                  fontSize: "12px",
                  fontWeight: "500",
                  cursor: refreshingLive ? "not-allowed" : "pointer",
                  display: "flex",
                  alignItems: "center",
                  gap: "4px",
                  transition: "all 0.2s"
                }}
                onMouseEnter={(e) => {
                  if (!refreshingLive) {
                    e.currentTarget.style.borderColor = "#94a3b8";
                    e.currentTarget.style.color = "#475569";
                  }
                }}
                onMouseLeave={(e) => {
                  if (!refreshingLive) {
                    e.currentTarget.style.borderColor = "#e5e7eb";
                    e.currentTarget.style.color = "#64748b";
                  }
                }}
              >
                {refreshingLive ? "Uppdaterar..." : "üîÑ Uppdatera"}
              </button>
              <button
                onClick={() => setShowHelpModal(true)}
                style={{
                  padding: "8px 16px",
                  background: "#f0f9ff",
                  color: "#0369a1",
                  border: "1px solid #bae6fd",
                  borderRadius: "6px",
                  fontSize: "13px",
                  fontWeight: "600",
                  cursor: "pointer",
                  transition: "all 0.2s"
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = "#e0f2fe";
                  e.currentTarget.style.borderColor = "#7dd3fc";
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = "#f0f9ff";
                  e.currentTarget.style.borderColor = "#bae6fd";
                }}
              >
                ‚ùì Hj√§lp
              </button>
            </div>
          )}
        </div>

        {watchlist.length > 0 && (
          <>
            <div style={{ display: "flex", gap: "8px", marginBottom: "8px", fontSize: "11px", flexWrap: "wrap" }}>
              <span style={{ color: "#64748b" }}>üîµ V√§nta</span>
              <span style={{ color: "#64748b" }}>üü° N√§rmar sig</span>
              <span style={{ color: "#64748b" }}>üü¢ Klar</span>
              <span style={{ color: "#64748b" }}>üü† Breakout</span>
              <span style={{ color: "#64748b" }}>üî¥ Ta bort</span>
            </div>
            <div style={{
              background: "#ecfdf5",
              border: "1px solid #a7f3d0",
              borderRadius: "6px",
              padding: "8px 12px",
              marginBottom: "12px",
              fontSize: "11px",
              color: "#065f46"
            }}>
              <strong>üéØ Breakout Alert:</strong> Visar n√§r priset √§r <strong>inom 0.5%</strong> fr√•n EMA20.
              Detta √§r perfekt tidpunkt att bevaka f√∂r entry! Kolumnen "EMA20 Œî%" visar exakt avst√•nd.
            </div>
          </>
        )}

        {watchlist.length === 0 ? (
          <p style={{ color: "#64748b", textAlign: "center", padding: "20px" }}>
            Ingen bevakning √§nnu. L√§gg till aktier fr√•n screener nedan.
          </p>
        ) : (
          <div style={{ overflowX: "auto" }}>
            <table style={{ width: "100%", fontSize: "13px", borderCollapse: "collapse" }}>
              <thead>
                <tr style={{ borderBottom: "2px solid #e2e8f0", color: "#64748b", fontSize: "11px", textTransform: "uppercase", letterSpacing: "0.05em" }}>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>Status</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>Blockering</th>
                  <th style={{ padding: "8px 12px", textAlign: "left" }}>Aktie</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>Info</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>Pris</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>F√∂r√§ndring</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>Volym</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>Dag High</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>Dag Low</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>EMA20 Œî%</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>Edge Score</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>RSI-zon</th>
                  <th style={{ padding: "8px 12px", textAlign: "right" }}>Oms. %</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}>Dagar</th>
                  <th style={{ padding: "8px 12px", textAlign: "center" }}></th>
                </tr>
              </thead>
              <tbody>
                {watchlist
                  .sort((a, b) => {
                    // Sort READY first, then APPROACHING, then others
                    const statusPriority = {
                      'READY': 1,
                      'APPROACHING': 2,
                      'BREAKOUT_ONLY': 3,
                      'WAIT_PULLBACK': 4,
                      'INVALIDATED': 5
                    };
                    const aPriority = statusPriority[a.current_status] || 99;
                    const bPriority = statusPriority[b.current_status] || 99;
                    return aPriority - bPriority;
                  })
                  .map((item) => {
                    const status = item.current_status || 'WAIT_PULLBACK';
                    const statusIcon = getStatusIcon(status);
                    const statusLabel = getStatusLabel(status);

                    // Row highlighting for READY status
                    const isReady = status === 'READY';
                    const rowBg = isReady ? "#f0fdf4" : "transparent";
                    const rowBorder = isReady ? "2px solid #86efac" : "1px solid #f1f5f9";

                    // EMA20 distance color coding
                    let ema20Color = "#64748b";
                    const emaDist = item.dist_ema20_pct;
                    let showBreakoutAlert = false;
                    if (emaDist !== null && emaDist !== undefined) {
                      if (Math.abs(emaDist) <= 0.5) {
                        ema20Color = "#16a34a"; // VERY close to breakout
                        showBreakoutAlert = true;
                      }
                      else if (Math.abs(emaDist) <= 1.5) ema20Color = "#16a34a"; // Perfect pullback
                      else if (Math.abs(emaDist) <= 3) ema20Color = "#3b82f6"; // Approaching
                      else if (Math.abs(emaDist) > 5) ema20Color = "#f59e0b"; // Too far
                    }

                    // RSI zone color coding
                    let rsiZoneColor = "#64748b";
                    const rsiZone = item.rsi_zone;
                    if (rsiZone === "CALM") rsiZoneColor = "#16a34a"; // Perfect
                    else if (rsiZone === "WARM") rsiZoneColor = "#3b82f6"; // OK
                    else if (rsiZone === "HOT") rsiZoneColor = "#dc2626"; // Too hot
                    else if (rsiZone === "WEAK") rsiZoneColor = "#f59e0b"; // Weak

                    // Volume state color coding
                    let volColor = "#64748b";
                    const volState = item.volume_state;
                    if (volState === "HIGH") volColor = "#16a34a";
                    else if (volState === "NORMAL") volColor = "#3b82f6";
                    else if (volState === "LOW") volColor = "#94a3b8";

                    // Trend health icon
                    const trendHealthIcon = item.initial_regime === "Bullish Trend" ? "‚úì" : "‚Äî";
                    const trendHealthColor = item.initial_regime === "Bullish Trend" ? "#16a34a" : "#94a3b8";

                    // Setup label
                    const setupLabel = item.initial_setup === "Pullback" ? "PB" :
                                      item.initial_setup === "Breakout" ? "BO" :
                                      item.initial_setup === "Trend Following" ? "TF" :
                                      item.initial_setup === "Reversal" ? "REV" : "‚Äî";

                    // Warning icon for long waiting
                    const showWarning = item.days_in_watchlist > 10 && status !== 'READY';

                    // Live data from Yahoo Finance
                    const quote = liveData[item.ticker] || {};
                    const livePrice = quote.regularMarketPrice;
                    const change = quote.regularMarketChange || 0;
                    const changePercent = quote.regularMarketChangePercent || 0;
                    const volume = quote.regularMarketVolume;
                    const dayHigh = quote.regularMarketDayHigh;
                    const dayLow = quote.regularMarketDayLow;
                    const isPositive = change >= 0;

                    // Fallback to database price if live data not available
                    const displayPrice = livePrice || item.current_price || item.initial_price;

                    // Calculate turnover from live data (or fallback to database)
                    const turnoverMSEK = (livePrice && volume)
                      ? (livePrice * volume) / 1_000_000
                      : item.turnoverMSEK;

                    // Calculate relative turnover (turnover as % of market cap)
                    const marketCap = quote.marketCap;
                    const marketCapMSEK = marketCap ? marketCap / 1_000_000 : null;
                    const relativeTurnover = (turnoverMSEK && marketCapMSEK)
                      ? (turnoverMSEK / marketCapMSEK) * 100
                      : null;

                    // Calculate blocking factors
                    const emaBlocks = status !== "READY" && (emaDist > 4 || emaDist < 0);
                    const rsiBlocks = status !== "READY" && (rsiZone === "WEAK" || rsiZone === "HOT");
                    const edgeBlocks = status !== "READY" && item.edge_score < 70;
                    const anyBlocks = emaBlocks || rsiBlocks || edgeBlocks;

                    return (
                      <>
                      <tr
                        key={item.ticker}
                        style={{
                          borderBottom: expandedRow === item.ticker ? "none" : rowBorder,
                          background: rowBg,
                          cursor: "pointer",
                          transition: "all 0.15s"
                        }}
                        onMouseEnter={(e) => {
                          if (!isReady) e.currentTarget.style.background = "#f8fafc";
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = rowBg;
                        }}
                        onClick={() => setExpandedRow(expandedRow === item.ticker ? null : item.ticker)}
                      >
                        {/* Status Icon */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }} onClick={(e) => { e.stopPropagation(); onSelectStock(item.ticker); }}>
                          <span style={{ fontSize: "20px" }}>{statusIcon}</span>
                        </td>

                        {/* Blockering */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <div style={{ display: "flex", gap: "2px", justifyContent: "center", fontSize: "14px" }}>
                            {!anyBlocks && <span title="Inga blockeringar!">‚úÖ</span>}
                            {emaBlocks && <span title="EMA20 Œî% blockerar (>4% eller <0%)">üìè</span>}
                            {rsiBlocks && <span title="RSI-zon blockerar (WEAK eller HOT)">üå°Ô∏è</span>}
                            {edgeBlocks && <span title="Edge Score blockerar (<70)">üìä</span>}
                          </div>
                        </td>

                        {/* Aktie */}
                        <td style={{ padding: "10px 12px" }} onClick={(e) => { e.stopPropagation(); onSelectStock(item.ticker); }}>
                          <div style={{ display: "flex", alignItems: "center", gap: "6px" }}>
                            <strong style={{ color: "#0f172a" }}>{item.ticker}</strong>
                            {showBreakoutAlert && (
                              <span style={{
                                fontSize: "10px",
                                fontWeight: "700",
                                color: "#16a34a",
                                background: "#dcfce7",
                                padding: "2px 6px",
                                borderRadius: "4px",
                                animation: "pulse 2s infinite"
                              }}>
                                üéØ BREAKOUT!
                              </span>
                            )}
                          </div>
                        </td>

                        {/* Yahoo Finance Link */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <a
                            href={`https://finance.yahoo.com/quote/${item.ticker}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            style={{
                              color: "#3b82f6",
                              textDecoration: "none",
                              fontSize: "16px",
                              display: "inline-block",
                              transition: "all 0.2s"
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.color = "#2563eb";
                              e.currentTarget.style.transform = "scale(1.1)";
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.color = "#3b82f6";
                              e.currentTarget.style.transform = "scale(1)";
                            }}
                            onClick={(e) => e.stopPropagation()}
                          >
                            üîó
                          </a>
                        </td>

                        {/* Pris (Live) */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums" }} onClick={() => onSelectStock(item.ticker)}>
                          <span style={{ fontWeight: "600" }}>
                            {displayPrice ? displayPrice.toFixed(2) : "‚Äî"}
                          </span>
                          {quote.currency && <span style={{ fontSize: "11px", color: "#94a3b8", marginLeft: "4px" }}>{quote.currency}</span>}
                        </td>

                        {/* F√∂r√§ndring (Live) */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums" }} onClick={() => onSelectStock(item.ticker)}>
                          {livePrice ? (
                            <span style={{
                              color: isPositive ? "#16a34a" : "#dc2626",
                              fontWeight: "600"
                            }}>
                              {isPositive ? "+" : ""}{change.toFixed(2)} ({isPositive ? "+" : ""}{changePercent.toFixed(2)}%)
                            </span>
                          ) : "‚Äî"}
                        </td>

                        {/* Volym (Live) */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums", fontSize: "12px" }} onClick={() => onSelectStock(item.ticker)}>
                          {volume ? volume.toLocaleString() : "‚Äî"}
                        </td>

                        {/* Dag High (Live) */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums" }} onClick={() => onSelectStock(item.ticker)}>
                          {dayHigh ? dayHigh.toFixed(2) : "‚Äî"}
                        </td>

                        {/* Dag Low (Live) */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums" }} onClick={() => onSelectStock(item.ticker)}>
                          {dayLow ? dayLow.toFixed(2) : "‚Äî"}
                        </td>

                        {/* EMA20 Œî% */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }} onClick={() => onSelectStock(item.ticker)}>
                          {emaDist !== null && emaDist !== undefined ? (
                            <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: "2px" }}>
                              <span style={{
                                fontWeight: "600",
                                color: ema20Color,
                                fontVariantNumeric: "tabular-nums",
                                fontSize: showBreakoutAlert ? "14px" : "13px",
                                textDecoration: (item.current_status !== "READY" && (emaDist > 4 || emaDist < 0)) ? "underline" : "none",
                                textDecorationThickness: "2px"
                              }}>
                                {emaDist > 0 ? '+' : ''}{emaDist.toFixed(1)}%
                              </span>
                              {showBreakoutAlert && (
                                <span style={{
                                  fontSize: "9px",
                                  color: "#16a34a",
                                  fontWeight: "700"
                                }}>
                                  ‚Üó N√ÑRA!
                                </span>
                              )}
                            </div>
                          ) : "‚Äî"}
                        </td>

                        {/* Edge Score */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }} onClick={() => onSelectStock(item.ticker)}>
                          {item.edge_score !== undefined && item.edge_score !== null ? (
                            <span style={{
                              fontSize: "13px",
                              fontWeight: "700",
                              color: item.edge_score >= 70 ? "#16a34a" : item.edge_score >= 50 ? "#f59e0b" : "#64748b",
                              background: item.edge_score >= 70 ? "#f0fdf4" : item.edge_score >= 50 ? "#fef3c7" : "#f8fafc",
                              padding: "4px 8px",
                              borderRadius: "4px",
                              textDecoration: (item.current_status !== "READY" && item.edge_score < 70) ? "underline" : "none",
                              textDecorationThickness: "2px"
                            }}>
                              {item.edge_score}
                            </span>
                          ) : (
                            <span style={{ color: "#94a3b8", fontSize: "12px" }}>‚Äî</span>
                          )}
                        </td>

                        {/* RSI-zon */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }} onClick={() => onSelectStock(item.ticker)}>
                          <span style={{
                            fontSize: "11px",
                            fontWeight: "600",
                            color: rsiZoneColor,
                            background: rsiZoneColor === "#16a34a" ? "#f0fdf4" : rsiZoneColor === "#dc2626" ? "#fef2f2" : "#f8fafc",
                            padding: "2px 6px",
                            borderRadius: "4px",
                            textDecoration: (item.current_status !== "READY" && (rsiZone === "WEAK" || rsiZone === "HOT")) ? "underline" : "none",
                            textDecorationThickness: "2px"
                          }}>
                            {rsiZone || "‚Äî"}
                          </span>
                        </td>

                        {/* Oms√§ttning (Relativ) */}
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums" }} onClick={() => onSelectStock(item.ticker)}>
                          {relativeTurnover !== null ? (
                            <span style={{
                              color: relativeTurnover >= 1.0 ? "#16a34a" : relativeTurnover >= 0.3 ? "#3b82f6" : "#94a3b8",
                              fontWeight: "500"
                            }}>
                              {relativeTurnover.toFixed(2)}%
                            </span>
                          ) : (
                            <span style={{
                              color: turnoverMSEK >= 100 ? "#16a34a" : turnoverMSEK >= 30 ? "#3b82f6" : "#94a3b8",
                              fontWeight: "500"
                            }}>
                              {turnoverMSEK ? `${turnoverMSEK.toFixed(0)}M` : "‚Äî"}
                            </span>
                          )}
                        </td>

                        {/* Dagar + Warning */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }} onClick={() => onSelectStock(item.ticker)}>
                          <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: "2px" }}>
                            <span style={{ fontSize: "12px", color: "#94a3b8", fontWeight: "500" }}>
                              {item.days_in_watchlist}d
                            </span>
                            {showWarning && (
                              <span style={{ fontSize: "14px", color: "#f59e0b" }} title={item.time_warning || "L√•ng v√§ntan"}>‚ö†Ô∏é</span>
                            )}
                          </div>
                        </td>

                        {/* Action Buttons */}
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <div style={{ display: "flex", gap: "4px", justifyContent: "center" }}>
                            <button
                              className="action-btn"
                              onClick={async (e) => {
                                e.stopPropagation();
                                const enrichedStock = await prepareStockForEntry(item);
                                setSelectedStock(enrichedStock);
                                setShowEntryModal(true);
                              }}
                              title={isReady ? "L√§gg till i portfolio" : "L√§gg till i portfolio (diskretion√§r entry)"}
                              style={{
                                background: isReady ? "#16a34a" : "#3b82f6",
                                border: isReady ? "1px solid #15803d" : "1px solid #2563eb",
                                color: "white",
                                fontSize: "12px",
                                fontWeight: "600",
                                padding: "4px 10px"
                              }}
                            >
                              K√ñP
                            </button>
                            {isReady && (
                              <button
                                className="action-btn"
                                onClick={() => onSelectStock(item.ticker)}
                                title="√ñppna chart"
                                style={{
                                  background: "#dcfce7",
                                  border: "1px solid #86efac",
                                  fontSize: "14px",
                                  padding: "4px 8px"
                                }}
                              >
                                üìà
                              </button>
                            )}
                            <button
                              className="action-btn delete"
                              onClick={(e) => {
                                e.stopPropagation();
                                removeFromWatchlist(item.ticker);
                              }}
                              title="Ta bort fr√•n bevakning"
                            >
                              ‚úï
                            </button>
                          </div>
                        </td>
                      </tr>

                      {/* Expanderad analys */}
                      {expandedRow === item.ticker && (
                        <tr key={`${item.ticker}-expanded`}>
                          <td colSpan="15" style={{ padding: "20px", background: "#f8fafc", borderBottom: rowBorder }}>
                            <div style={{ maxWidth: "900px", margin: "0 auto" }}>
                              <h3 style={{ fontSize: "18px", fontWeight: "700", color: "#0f172a", marginBottom: "16px", display: "flex", alignItems: "center", gap: "8px" }}>
                                üìä Hur n√§ra √§r {item.ticker} att bli üü¢ READY?
                              </h3>

                              {/* Nuvarande parametrar */}
                              <div style={{ marginBottom: "20px", padding: "16px", background: "white", borderRadius: "8px", border: "1px solid #e5e7eb" }}>
                                <h4 style={{ fontSize: "14px", fontWeight: "600", color: "#64748b", marginBottom: "12px" }}>Nuvarande parametrar:</h4>
                                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))", gap: "12px", fontSize: "13px" }}>
                                  <div><strong>Status:</strong> {statusIcon} {statusLabel}</div>
                                  <div><strong>EMA20 Œî%:</strong> <span style={{ color: ema20Color, fontWeight: "600" }}>{emaDist !== null ? `${emaDist > 0 ? '+' : ''}${emaDist.toFixed(1)}%` : "‚Äî"}</span></div>
                                  <div><strong>RSI-zon:</strong> <span style={{ color: rsiZoneColor, fontWeight: "600" }}>{rsiZone || "‚Äî"}</span></div>
                                  <div><strong>Edge Score:</strong> <span style={{ color: item.edge_score >= 70 ? "#16a34a" : item.edge_score >= 50 ? "#f59e0b" : "#64748b", fontWeight: "600" }}>{item.edge_score || "‚Äî"}</span></div>
                                  <div><strong>Dagar i lista:</strong> {item.days_in_watchlist || 0}</div>
                                </div>
                              </div>

                              {/* Vad som √§r BRA */}
                              <div style={{ marginBottom: "16px", padding: "16px", background: "#f0fdf4", borderRadius: "8px", border: "1px solid #86efac" }}>
                                <h4 style={{ fontSize: "14px", fontWeight: "600", color: "#15803d", marginBottom: "8px" }}>‚úÖ Det som √§r BRA:</h4>
                                <div style={{ fontSize: "13px", color: "#166534" }}>
                                  {!emaBlocks && <div>‚Ä¢ <strong>EMA20 Œî% = {emaDist?.toFixed(1)}%</strong> - {Math.abs(emaDist) <= 1.5 ? "Perfekt i READY-zonen!" : emaDist <= 2 ? "Inom READY-zonen (0-2%)" : emaDist <= 4 ? "N√§rmar sig (2-4%)" : "OK"}</div>}
                                  {!edgeBlocks && <div>‚Ä¢ <strong>Edge Score = {item.edge_score}</strong> - {item.edge_score >= 70 ? "Stark statistisk kvalitet!" : "OK kvalitet"}</div>}
                                  {!rsiBlocks && <div>‚Ä¢ <strong>RSI-zon = {rsiZone}</strong> - {rsiZone === "CALM" ? "Perfekt momentum!" : "Acceptabelt momentum"}</div>}
                                  {!anyBlocks && <div>‚Ä¢ <strong>Inga blockeringar!</strong> Alla parametrar √§r inom gr√∂na zonen ‚úÖ</div>}
                                </div>
                              </div>

                              {/* Vad som BLOCKERAR */}
                              {anyBlocks && (
                                <div style={{ marginBottom: "16px", padding: "16px", background: "#fef2f2", borderRadius: "8px", border: "1px solid #fecaca" }}>
                                  <h4 style={{ fontSize: "14px", fontWeight: "600", color: "#991b1b", marginBottom: "8px" }}>‚ö†Ô∏è Det som BLOCKERAR üü¢:</h4>
                                  <div style={{ fontSize: "13px", color: "#991b1b" }}>
                                    {emaBlocks && (
                                      <div style={{ marginBottom: "8px" }}>
                                        ‚Ä¢ <strong>üìè EMA20 Œî% = {emaDist?.toFixed(1)}%</strong> -
                                        {emaDist > 4 ? ` F√∂r l√•ngt fr√•n pullback-zonen (beh√∂ver komma under 2%)` :
                                         emaDist < 0 ? ` Under EMA20 (pullback f√∂r djup, beh√∂ver st√§nga √∂ver EMA20)` :
                                         ` Blockerar av ok√§nd anledning`}
                                      </div>
                                    )}
                                    {rsiBlocks && (
                                      <div style={{ marginBottom: "8px" }}>
                                        ‚Ä¢ <strong>üå°Ô∏è RSI-zon = {rsiZone}</strong> -
                                        {rsiZone === "WEAK" ? ` F√∂r svagt momentum (beh√∂ver st√§rkas till CALM eller WARM)` :
                                         rsiZone === "HOT" ? ` F√∂r starkt momentum (beh√∂ver svalna till CALM, RSI 40-55)` :
                                         ` Momentum ej optimalt`}
                                      </div>
                                    )}
                                    {edgeBlocks && (
                                      <div style={{ marginBottom: "8px" }}>
                                        ‚Ä¢ <strong>üìä Edge Score = {item.edge_score}</strong> - Under optimal tr√∂skel (beh√∂ver ‚â•70 f√∂r h√∂gsta kvalitet)
                                      </div>
                                    )}
                                  </div>
                                </div>
                              )}

                              {/* Bed√∂mning */}
                              <div style={{ padding: "16px", background: "#eff6ff", borderRadius: "8px", border: "1px solid #93c5fd" }}>
                                <h4 style={{ fontSize: "14px", fontWeight: "600", color: "#1e40af", marginBottom: "8px" }}>üí° Bed√∂mning:</h4>
                                <div style={{ fontSize: "13px", color: "#1e40af" }}>
                                  {!anyBlocks ? (
                                    <div><strong>PERFEKT!</strong> Alla f√∂ruts√§ttningar √§r uppfyllda f√∂r k√∂p. ‚úÖ</div>
                                  ) : (
                                    <>
                                      <div style={{ marginBottom: "8px" }}>
                                        <strong>{item.ticker} √§r {
                                          (emaBlocks && rsiBlocks && edgeBlocks) ? "l√•ngt fr√•n" :
                                          (emaBlocks && rsiBlocks) || (emaBlocks && edgeBlocks) || (rsiBlocks && edgeBlocks) ? "en bit fr√•n" :
                                          "MYCKET n√§ra"
                                        } att bli gr√∂n!</strong>
                                      </div>
                                      {!emaBlocks && !edgeBlocks && rsiBlocks && (
                                        <div>Endast RSI blockerar - allt annat √§r perfekt! Om {rsiZone === "HOT" ? "priset konsoliderar" : "momentum st√§rks"} kan detta bli gr√∂nt inom 1-3 dagar.</div>
                                      )}
                                      {emaBlocks && !rsiBlocks && (
                                        <div>EMA20 Œî% blockerar - v√§nta p√• att priset {emaDist > 4 ? "g√∂r pullback mot EMA20" : "stiger √∂ver EMA20"}.</div>
                                      )}
                                      {edgeBlocks && !emaBlocks && !rsiBlocks && (
                                        <div>Timing √§r perfekt men Edge Score √§r under 70. Detta √§r fortfarande handelbart men med n√•got l√§gre statistisk kvalitet.</div>
                                      )}
                                    </>
                                  )}
                                </div>
                              </div>
                            </div>
                          </td>
                        </tr>
                      )}
                      </>
                    );
                  })
                }
              </tbody>
            </table>

            {/* Info section below table */}
            <div style={{ marginTop: "16px", fontSize: "12px", color: "#64748b", display: "flex", flexDirection: "column", gap: "8px" }}>
              <div>
                <strong>Oms. %:</strong> Relativ oms√§ttning (daglig oms√§ttning / b√∂rsv√§rde √ó 100).
                <span style={{ color: "#16a34a", fontWeight: "600" }}> ‚â•1.0% = H√∂g likviditet</span>,
                <span style={{ color: "#3b82f6", fontWeight: "600" }}> 0.3-1.0% = OK</span>,
                <span style={{ color: "#94a3b8", fontWeight: "600" }}> &lt;0.3% = L√•g</span>
              </div>
              <div>
                <strong>Senaste uppdatering:</strong> K√∂r <code style={{ background: "#f1f5f9", padding: "2px 6px", borderRadius: "4px" }}>POST /api/watchlist/update</code> f√∂r daglig statusuppdatering
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Screener */}
      <div className="card" style={{ marginBottom: "16px" }}>
        <div className="card-header">
          <p className="eyebrow">Screener ‚Äì Ranking</p>
          <span className="tag">Uppdateras dagligen</span>
        </div>

        {/* Search Box */}
        <div style={{ marginBottom: "16px" }}>
          <form onSubmit={handleSearch}>
            <div style={{ display: "flex", gap: "8px" }}>
              <input
                type="text"
                placeholder="S√∂k aktie (t.ex. AAPL, TSLA, VOLV-B.ST)"
                value={customInput}
                onChange={(e) => setCustomInput(e.target.value)}
                className="stock-input"
              />
              <button type="submit" className="ghost" disabled={!customInput.trim()}>
                S√∂k
              </button>
            </div>
          </form>
        </div>

        {screenerLoading && <p style={{ color: "#64748b", fontSize: "14px" }}>Laddar screener...</p>}

        {screenerData && screenerData.length > 0 && (
          <>
            <div style={{ overflowX: "auto" }}>
              <table className="screener-table" style={{ width: "100%", fontSize: "13px", borderCollapse: "collapse" }}>
                <thead>
                  <tr style={{ borderBottom: "2px solid #e2e8f0", color: "#64748b", fontSize: "11px", textTransform: "uppercase", letterSpacing: "0.05em" }}>
                    <th style={{ padding: "8px 12px", textAlign: "left" }}>#</th>
                    <th style={{ padding: "8px 12px", textAlign: "left" }}>Aktie</th>
                    <th style={{ padding: "8px 12px", textAlign: "center" }}>Segment</th>
                    <th style={{ padding: "8px 12px", textAlign: "right" }}>Pris</th>
                    <th style={{ padding: "8px 12px", textAlign: "right" }}>Oms.</th>
                    <th style={{ padding: "8px 12px", textAlign: "center" }}>Trend</th>
                    <th style={{ padding: "8px 12px", textAlign: "right" }}>RSI</th>
                    <th style={{ padding: "8px 12px", textAlign: "right" }}>Vol√ó</th>
                    <th style={{ padding: "8px 12px", textAlign: "right" }}>ATR%</th>
                    <th style={{ padding: "8px 12px", textAlign: "left" }}>Setup</th>
                    <th style={{ padding: "8px 12px", textAlign: "right" }}>Score</th>
                    <th style={{ padding: "8px 12px", textAlign: "center" }}></th>
                  </tr>
                </thead>
                <tbody>
                  {screenerData.map((item, idx) => {
                    const edgeScore = item.edgeScore || 50; // Backend now uses 0-100 scale
                    let scoreColor = "#dc2626";
                    if (edgeScore >= 70) scoreColor = "#16a34a";
                    else if (edgeScore >= 50) scoreColor = "#f59e0b";

                    const trendIcon = item.regime === "Bullish Trend" ? "‚ñ≤" : item.regime === "Bearish Trend" ? "‚ñº" : "‚Üí";
                    const trendColor = item.regime === "Bullish Trend" ? "#16a34a" : item.regime === "Bearish Trend" ? "#dc2626" : "#64748b";

                    const rsiValue = item.rsi?.toFixed(0) || "N/A";
                    let rsiColor = "#64748b";
                    if (item.rsi >= 35 && item.rsi <= 45) rsiColor = "#16a34a";
                    else if (item.rsi >= 45 && item.rsi <= 60) rsiColor = "#3b82f6";
                    else if (item.rsi > 70) rsiColor = "#dc2626";
                    else if (item.rsi < 30) rsiColor = "#f59e0b";

                    const volRatio = item.relativeVolume?.toFixed(1) || "N/A";
                    let volColor = "#64748b";
                    if (item.relativeVolume >= 1.5) volColor = "#16a34a";
                    else if (item.relativeVolume >= 1.2) volColor = "#3b82f6";
                    else if (item.relativeVolume < 1.0) volColor = "#94a3b8";

                    const atrPct = item.atr && item.price ? ((item.atr / item.price) * 100).toFixed(1) : "N/A";
                    let atrColor = "#64748b";
                    if (parseFloat(atrPct) >= 2 && parseFloat(atrPct) <= 4) atrColor = "#16a34a";
                    else if (parseFloat(atrPct) > 6) atrColor = "#f59e0b";
                    else if (parseFloat(atrPct) < 2) atrColor = "#94a3b8";

                    const setupLabel = item.setup === "Pullback" ? "PB" :
                                      item.setup === "Breakout" ? "BO" :
                                      item.setup === "Trend Following" ? "TF" :
                                      item.setup === "Reversal" ? "REV" : "RNG";

                    return (
                      <tr
                        key={item.ticker}
                        style={{
                          borderBottom: "1px solid #f1f5f9",
                          cursor: "pointer",
                          transition: "background 0.15s"
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.background = "#f8fafc"}
                        onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}
                        onClick={() => onSelectStock(item.ticker)}
                      >
                        <td style={{ padding: "10px 12px", color: "#94a3b8", fontWeight: "500" }}>
                          {idx + 1}
                        </td>
                        <td style={{ padding: "10px 12px" }}>
                          <strong style={{ color: "#0f172a" }}>{item.ticker}</strong>
                        </td>
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <span style={{
                            fontSize: "10px",
                            fontWeight: "700",
                            color: item.bucket === "LARGE_CAP" ? "#3b82f6" : "#8b5cf6",
                            background: item.bucket === "LARGE_CAP" ? "#dbeafe" : "#ede9fe",
                            padding: "3px 8px",
                            borderRadius: "4px",
                            letterSpacing: "0.025em"
                          }}>
                            {item.bucket === "LARGE_CAP" ? "LARGE" : "MID"}
                          </span>
                        </td>
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums" }}>
                          {item.price?.toFixed(2) || "N/A"}
                        </td>
                        <td style={{ padding: "10px 12px", textAlign: "right", fontVariantNumeric: "tabular-nums" }}>
                          <span style={{
                            color: item.turnoverMSEK >= 100 ? "#16a34a" : item.turnoverMSEK >= 30 ? "#64748b" : "#94a3b8",
                            fontWeight: "500"
                          }}>
                            {item.turnoverMSEK?.toFixed(0) || "N/A"}M
                          </span>
                        </td>
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <span style={{ fontSize: "16px", color: trendColor }}>{trendIcon}</span>
                        </td>
                        <td style={{ padding: "10px 12px", textAlign: "right", fontWeight: "600", color: rsiColor }}>
                          {rsiValue}
                        </td>
                        <td style={{ padding: "10px 12px", textAlign: "right", fontWeight: "600", color: volColor }}>
                          {volRatio}√ó
                        </td>
                        <td style={{ padding: "10px 12px", textAlign: "right", fontWeight: "600", color: atrColor }}>
                          {atrPct}%
                        </td>
                        <td style={{ padding: "10px 12px" }}>
                          <span style={{
                            fontSize: "11px",
                            fontWeight: "600",
                            color: "#64748b",
                            background: "#f1f5f9",
                            padding: "2px 6px",
                            borderRadius: "4px"
                          }}>
                            {setupLabel}
                          </span>
                        </td>
                        <td style={{ padding: "10px 12px", textAlign: "right" }}>
                          <span style={{
                            fontWeight: "700",
                            color: scoreColor,
                            fontSize: "14px"
                          }}>
                            {edgeScore.toFixed(0)}
                          </span>
                        </td>
                        <td style={{ padding: "10px 12px", textAlign: "center" }}>
                          <button
                            className="action-btn"
                            onClick={(e) => {
                              e.stopPropagation();
                              addToWatchlist(item.ticker, {
                                price: item.price,
                                ema20: item.ema20,
                                ema50: item.ema50,
                                rsi14: item.rsi,
                                regime: item.regime,
                                setup: item.setup,
                                relativeVolume: item.relativeVolume
                              });
                            }}
                            title="L√§gg till i bevakning"
                            style={{
                              background: "#dbeafe",
                              border: "1px solid #93c5fd",
                              fontSize: "14px",
                              padding: "4px 8px"
                            }}
                          >
                            ‚òÖ
                          </button>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            <div style={{ marginTop: "12px", fontSize: "11px", color: "#64748b", display: "flex", gap: "16px", flexWrap: "wrap" }}>
              <span>Trend: <strong style={{ color: "#16a34a" }}>‚ñ≤</strong> Upptrend <strong style={{ color: "#64748b" }}>‚Üí</strong> Range <strong style={{ color: "#dc2626" }}>‚ñº</strong> Nedtrend</span>
              <span>Setup: <strong>PB</strong>=Pullback <strong>BO</strong>=Breakout <strong>TF</strong>=Trend Following</span>
            </div>
          </>
        )}
      </div>

      {/* Entry Modal */}
      {showEntryModal && selectedStock && (
        <EntryModal
          stock={selectedStock}
          onClose={() => {
            setShowEntryModal(false);
            setSelectedStock(null);
          }}
          onConfirm={handleAddToPortfolio}
        />
      )}

      {/* Help Modal */}
      {showHelpModal && (
        <div
          style={{
            position: "fixed",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: "rgba(0, 0, 0, 0.5)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            zIndex: 1000,
            padding: "20px"
          }}
          onClick={() => setShowHelpModal(false)}
        >
          <div
            style={{
              background: "white",
              borderRadius: "12px",
              maxWidth: "800px",
              maxHeight: "90vh",
              overflow: "auto",
              padding: "24px",
              boxShadow: "0 10px 25px rgba(0, 0, 0, 0.2)"
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "20px" }}>
              <h2 style={{ fontSize: "24px", fontWeight: "700", color: "#0f172a", margin: 0 }}>
                üìö Guide: Hur du anv√§nder bevakningslistan
              </h2>
              <button
                onClick={() => setShowHelpModal(false)}
                style={{
                  background: "none",
                  border: "none",
                  fontSize: "24px",
                  cursor: "pointer",
                  color: "#64748b",
                  padding: "0",
                  lineHeight: "1"
                }}
              >
                √ó
              </button>
            </div>

            <div style={{ fontSize: "14px", color: "#334155", lineHeight: "1.6" }}>
              {/* Mest kritiska faktorer */}
              <section style={{ marginBottom: "24px" }}>
                <h3 style={{ fontSize: "18px", fontWeight: "700", color: "#0f172a", marginBottom: "12px", borderBottom: "2px solid #e2e8f0", paddingBottom: "8px" }}>
                  üéØ Mest kritiska f√∂r k√∂pbeslut (i prioritetsordning)
                </h3>

                <div style={{ marginBottom: "16px" }}>
                  <h4 style={{ fontSize: "15px", fontWeight: "700", color: "#0369a1", marginBottom: "8px" }}>
                    1. Status (Emoji) - TYNGST
                  </h4>
                  <div style={{ paddingLeft: "16px", fontSize: "13px" }}>
                    <div style={{ marginBottom: "4px" }}><span style={{ fontWeight: "600" }}>üü¢ READY</span> = Perfekt l√§ge att k√∂pa NU - alla f√∂ruts√§ttningar uppfyllda</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ fontWeight: "600" }}>üü° APPROACHING</span> = Snart k√∂pl√§ge, bevaka noga</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ fontWeight: "600" }}>üîµ WAIT_PULLBACK</span> = V√§nta p√• b√§ttre pris/pullback</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ fontWeight: "600" }}>üü† BREAKOUT_ONLY</span> = K√∂p bara vid breakout √∂ver motst√•nd</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ fontWeight: "600" }}>üî¥ INVALIDATED</span> = Ta bort fr√•n listan, setupen √§r ogiltig</div>
                    <div style={{ marginTop: "8px", padding: "8px", background: "#f8fafc", borderRadius: "4px", fontSize: "12px", color: "#475569" }}>
                      <strong>üí° Hur ber√§knas status?</strong><br/>
                      Status √§r ett <em>sammansatt beslut</em> baserat p√• EMA20 Œî%, RSI-zon, volym, EMA50 slope och prisstruktur. De andra kolumnerna visar underliggande faktorer s√• du kan verifiera beslutet.
                    </div>
                  </div>
                </div>

                <div style={{ marginBottom: "16px" }}>
                  <h4 style={{ fontSize: "15px", fontWeight: "700", color: "#0369a1", marginBottom: "8px" }}>
                    2. EMA20 Œî% - N√ÑST TYNGST
                  </h4>
                  <div style={{ paddingLeft: "16px", fontSize: "13px" }}>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#16a34a", fontWeight: "600" }}>Gr√∂n, inom ¬±1.5%</span> = Perfekt pullback-l√§ge! ‚úÖ</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#16a34a", fontWeight: "600" }}>Gr√∂n, inom ¬±0.5%</span> = üéØ BREAKOUT ALERT - k√∂p NU!</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#3b82f6", fontWeight: "600" }}>Bl√•, 1.5-3%</span> = N√§rmar sig, bevaka</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#f59e0b", fontWeight: "600" }}>Orange, &gt;5%</span> = F√∂r l√•ngt fr√•n trend, v√§nta</div>
                  </div>
                </div>

                <div style={{ marginBottom: "16px" }}>
                  <h4 style={{ fontSize: "15px", fontWeight: "700", color: "#0369a1", marginBottom: "8px" }}>
                    3. Edge Score
                  </h4>
                  <div style={{ paddingLeft: "16px", fontSize: "13px" }}>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#16a34a", fontWeight: "600" }}>Gr√∂n ‚â•70</span> = Starkast statistisk edge, prioritera dessa!</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#f59e0b", fontWeight: "600" }}>Orange 50-69</span> = OK edge, kan handlas</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#64748b", fontWeight: "600" }}>Gr√• &lt;50</span> = Svag edge, √∂verv√§g att skippa</div>
                  </div>
                </div>

                <div style={{ marginBottom: "16px" }}>
                  <h4 style={{ fontSize: "15px", fontWeight: "700", color: "#0369a1", marginBottom: "8px" }}>
                    4. RSI-zon
                  </h4>
                  <div style={{ paddingLeft: "16px", fontSize: "13px" }}>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#16a34a", fontWeight: "600" }}>CALM</span> = B√§st, inte √∂verstr√§ckt (RSI 40-60)</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#3b82f6", fontWeight: "600" }}>WARM</span> = OK, lite varmt (RSI 60-70)</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#dc2626", fontWeight: "600" }}>HOT</span> = √ñverk√∂pt, v√§nta p√• pullback</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#f59e0b", fontWeight: "600" }}>WEAK</span> = Svag, kanske undvik</div>
                  </div>
                </div>

                <div style={{ marginBottom: "16px" }}>
                  <h4 style={{ fontSize: "15px", fontWeight: "700", color: "#0369a1", marginBottom: "8px" }}>
                    5. Oms. % (Relativ oms√§ttning)
                  </h4>
                  <div style={{ paddingLeft: "16px", fontSize: "13px" }}>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#16a34a", fontWeight: "600" }}>Gr√∂n ‚â•1.0%</span> = H√∂g likviditet, l√§tt att k√∂pa/s√§lja ‚úÖ</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#3b82f6", fontWeight: "600" }}>Bl√• 0.3-1.0%</span> = OK likviditet</div>
                    <div style={{ marginBottom: "4px" }}><span style={{ color: "#94a3b8", fontWeight: "600" }}>Ljusgr√• &lt;0.3%</span> = L√•g likviditet, risk f√∂r spread</div>
                  </div>
                </div>

                <div style={{ marginBottom: "16px" }}>
                  <h4 style={{ fontSize: "15px", fontWeight: "700", color: "#0369a1", marginBottom: "8px" }}>
                    6. Dagar (Tid sedan signal)
                  </h4>
                  <div style={{ paddingLeft: "16px", fontSize: "13px" }}>
                    <div style={{ marginBottom: "4px" }}>1-3 dagar = F√§rsk signal, h√∂gre sannolikhet</div>
                    <div style={{ marginBottom: "4px" }}>4-7 dagar = OK, fortfarande giltig</div>
                    <div style={{ marginBottom: "4px" }}>&gt;10 dagar med ‚ö†Ô∏é = Gammal signal, √∂verv√§g att ta bort</div>
                  </div>
                </div>
              </section>

              {/* Checklista */}
              <section style={{ marginBottom: "24px", background: "#f0fdf4", padding: "16px", borderRadius: "8px", border: "1px solid #a7f3d0" }}>
                <h3 style={{ fontSize: "18px", fontWeight: "700", color: "#065f46", marginBottom: "12px" }}>
                  ‚úÖ Praktiskt beslutsfl√∂de f√∂r k√∂p
                </h3>
                <div style={{ fontSize: "13px", color: "#065f46" }}>
                  <div style={{ marginBottom: "12px", fontWeight: "600" }}>K√∂p n√§r ALLA dessa st√§mmer:</div>
                  <div style={{ paddingLeft: "16px" }}>
                    <div style={{ marginBottom: "4px" }}>‚úÖ <strong>Steg 1:</strong> Status = üü¢ READY</div>
                    <div style={{ marginBottom: "4px" }}>‚úÖ <strong>Steg 2:</strong> EMA20 Œî% inom ¬±1.5% (gr√∂n)</div>
                    <div style={{ marginBottom: "4px" }}>‚úÖ <strong>Steg 3:</strong> Edge Score ‚â•70</div>
                    <div style={{ marginBottom: "4px" }}>‚úÖ <strong>Steg 4:</strong> RSI-zon = CALM</div>
                    <div style={{ marginBottom: "8px", fontSize: "12px", color: "#047857" }}>
                      <em>Om alla 4 √§r uppfyllda ‚Üí stark k√∂psignal! Oms. % och Dagar √§r st√∂djande faktorer.</em>
                    </div>
                  </div>
                </div>
              </section>

              {/* Analysera icke-gr√∂na statusar */}
              <section style={{ marginBottom: "24px", background: "#eff6ff", padding: "16px", borderRadius: "8px", border: "1px solid #93c5fd" }}>
                <h3 style={{ fontSize: "18px", fontWeight: "700", color: "#1e3a8a", marginBottom: "12px" }}>
                  üîé Om status INTE √§r üü¢ - hur n√§ra √§r den?
                </h3>
                <div style={{ fontSize: "13px", color: "#1e40af" }}>
                  <p style={{ marginBottom: "12px" }}><strong>Status √§r l√§tt om den √§r gr√∂n - men vad g√∂r du n√§r den √§r bl√•/gul/orange?</strong><br/>H√§r √§r hur du bed√∂mer hur n√§ra ett k√∂pl√§ge aktien √§r:</p>

                  <div style={{ marginBottom: "12px" }}>
                    <strong>üü° APPROACHING (Gul) - Hur n√§ra √§r den?</strong><br/>
                    ‚úì Kolla <strong>EMA20 Œî%</strong>: Om den √§r 2.5% ‚Üí n√§stan d√§r! Om 3.8% ‚Üí lite l√§ngre kvar<br/>
                    ‚úì Kolla <strong>RSI-zon</strong>: √Ñr den redan CALM? ‚Üí Perfekt, v√§ntar bara p√• pullback<br/>
                    ‚úì Kolla <strong>Edge Score</strong>: ‚â•70? ‚Üí Starkt case, bevaka aktivt!<br/>
                    <em style={{ fontSize: "12px" }}>‚Üí Om EMA20 Œî% n√§rmar sig 2% OCH RSI = CALM = b√∂rja f√∂rbereda dig!</em>
                  </div>

                  <div style={{ marginBottom: "12px" }}>
                    <strong>üîµ WAIT_PULLBACK (Bl√•) - Varf√∂r inte gr√∂n?</strong><br/>
                    Tre m√∂jliga orsaker - kolla vilken som g√§ller:<br/>
                    1. <strong>EMA20 Œî% &gt;4%</strong> (orange) ‚Üí F√∂r l√•ngt bort, v√§nta p√• pullback<br/>
                    2. <strong>EMA20 Œî% negativt</strong> ‚Üí Under EMA20, pullback f√∂r djup<br/>
                    3. <strong>RSI-zon = WEAK</strong> ‚Üí Momentum f√∂r svagt (RSI &lt;40)<br/>
                    <em style={{ fontSize: "12px" }}>‚Üí Fokusera p√• den parameter som blockerar. T.ex. om EMA20 Œî% = 5.2%, bevaka n√§r den g√•r mot 3%.</em>
                  </div>

                  <div style={{ marginBottom: "12px" }}>
                    <strong>üü† BREAKOUT_ONLY (Orange) - Specialfall</strong><br/>
                    ‚úì RSI &gt;65 (HOT) ‚Üí F√∂r starkt momentum f√∂r pullback-entry<br/>
                    ‚úì Kolla <strong>EMA20 Œî%</strong>: Om den √§r gr√∂n (0-2%) ‚Üí priset √ÑR vid EMA20, men f√∂r hett<br/>
                    <em style={{ fontSize: "12px" }}>‚Üí Tv√• alternativ: 1) V√§nta tills RSI svalnar till CALM, eller 2) K√∂p endast vid breakout √∂ver motst√•nd</em>
                  </div>

                  <div>
                    <strong>üí° Pro-taktik: Daglig diagnos</strong><br/>
                    Varje morgon efter üîÑ Uppdatera:<br/>
                    ‚Ä¢ üü° som g√•r mot gr√∂n EMA20 Œî% + CALM RSI = <strong>l√§gg i "bevaka aktivt"</strong><br/>
                    ‚Ä¢ üîµ med EMA20 Œî% 5% ‚Üí 4% ‚Üí 3.5% = <strong>r√§tt riktning, forts√§tt bevaka</strong><br/>
                    ‚Ä¢ üü† med RSI 68 ‚Üí 62 ‚Üí 58 = <strong>b√∂rjar svalna, snart CALM</strong>
                  </div>
                </div>
              </section>

              {/* Edge Score vs Status */}
              <section style={{ marginBottom: "24px", background: "#faf5ff", padding: "16px", borderRadius: "8px", border: "1px solid #d8b4fe" }}>
                <h3 style={{ fontSize: "18px", fontWeight: "700", color: "#6b21a8", marginBottom: "12px" }}>
                  üéØ Edge Score vs Status - Vad √§r skillnaden?
                </h3>
                <div style={{ fontSize: "13px", color: "#581c87" }}>
                  <div style={{ marginBottom: "12px" }}>
                    <strong>Edge Score</strong> (Backtest-baserad kvalitet)<br/>
                    <div style={{ paddingLeft: "16px", marginTop: "4px" }}>
                      ‚Ä¢ <strong>Vad:</strong> En siffra 0-100 som visar hur BRA denna aktie historiskt har presterat med din strategi<br/>
                      ‚Ä¢ <strong>K√§lla:</strong> Kommer fr√•n backtesting - analys av tidigare trades<br/>
                      ‚Ä¢ <strong>M√§ter:</strong> Kvalitet och tillf√∂rlitlighet (win rate, genomsnittlig vinst vs f√∂rlust, antal signaler)<br/>
                      ‚Ä¢ <strong>Tolkning:</strong> ‚â•70 = Gr√∂n (h√∂g kvalitet) | 50-69 = Orange (OK) | &lt;50 = Gr√• (l√•g kvalitet)<br/>
                      ‚Ä¢ <em style={{ fontSize: "12px" }}>En aktie kan ha Edge Score 85 (mycket bra historik) men √§nd√• inte vara i r√§tt l√§ge just NU f√∂r att k√∂pa.</em>
                    </div>
                  </div>

                  <div style={{ marginBottom: "12px" }}>
                    <strong>Status</strong> (Nul√§ge f√∂r k√∂ptiming)<br/>
                    <div style={{ paddingLeft: "16px", marginTop: "4px" }}>
                      ‚Ä¢ <strong>Vad:</strong> En bed√∂mning av om aktien √§r i r√§tt l√§ge att k√∂pa JUST NU<br/>
                      ‚Ä¢ <strong>K√§lla:</strong> Ber√§knas live fr√•n tekniska indikatorer (EMA20 Œî%, RSI-zon, volym, trend)<br/>
                      ‚Ä¢ <strong>M√§ter:</strong> Timing och setup-kvalitet i nul√§get (pullback n√§ra EMA20? Momentum lagom? Trend intakt?)<br/>
                      ‚Ä¢ <strong>Tolkning:</strong> üü¢ READY = Perfekt l√§ge NU | üü° APPROACHING = N√§stan d√§r | üîµ WAIT_PULLBACK = V√§nta<br/>
                      ‚Ä¢ <em style={{ fontSize: "12px" }}>En aktie kan ha status üü¢ READY (perfekt timing nu) men Edge Score 55 (medioker historik).</em>
                    </div>
                  </div>

                  <div style={{ marginBottom: "12px", background: "#fff", padding: "12px", borderRadius: "6px", border: "1px solid #e9d5ff" }}>
                    <strong>Hur de samarbetar:</strong><br/>
                    <div style={{ paddingLeft: "16px", marginTop: "6px", fontSize: "12px" }}>
                      <div style={{ marginBottom: "4px" }}>‚úÖ Edge Score 85 + üü¢ READY = <strong>PERFEKT!</strong> (H√∂g kvalitet + r√§tt timing)</div>
                      <div style={{ marginBottom: "4px" }}>‚ö†Ô∏è Edge Score 85 + üü° APPROACHING = Bra aktie, v√§nta lite till</div>
                      <div style={{ marginBottom: "4px" }}>‚ö†Ô∏è Edge Score 55 + üü¢ READY = R√§tt timing men tveksam kvalitet</div>
                      <div style={{ marginBottom: "4px" }}>‚ùå Edge Score 45 + üîµ WAIT_PULLBACK = B√•de d√•lig kvalitet OCH fel timing</div>
                    </div>
                  </div>

                  <div style={{ background: "#fff", padding: "12px", borderRadius: "6px", border: "1px solid #e9d5ff" }}>
                    <strong>üí° Praktiskt beslutsfl√∂de:</strong><br/>
                    <div style={{ paddingLeft: "16px", marginTop: "6px", fontSize: "12px" }}>
                      1. <strong>Filtrera f√∂rst p√• Edge Score</strong> (‚â•70) = "Vilka aktier √§r v√§rda att bevaka?"<br/>
                      2. <strong>Sen kolla Status dagligen</strong> = "N√§r √§r r√§tt l√§ge att k√∂pa?"<br/>
                      3. <strong>Kombinera med understrykningar</strong> = "Vad blockerar en perfekt setup?"
                    </div>
                  </div>
                </div>
              </section>

              {/* Varningssignaler */}
              <section style={{ marginBottom: "24px", background: "#fef2f2", padding: "16px", borderRadius: "8px", border: "1px solid #fecaca" }}>
                <h3 style={{ fontSize: "18px", fontWeight: "700", color: "#991b1b", marginBottom: "12px" }}>
                  üö® Varningssignaler (V√ÑNTA med k√∂p)
                </h3>
                <div style={{ fontSize: "13px", color: "#991b1b", paddingLeft: "16px" }}>
                  <div style={{ marginBottom: "4px" }}>‚ö†Ô∏è EMA20 Œî% orange (&gt;5%) - priset f√∂r l√•ngt fr√•n trend</div>
                  <div style={{ marginBottom: "4px" }}>‚ö†Ô∏è RSI-zon = HOT - √∂verk√∂pt, v√§nta p√• pullback</div>
                  <div style={{ marginBottom: "4px" }}>‚ö†Ô∏è Dagar &gt;10 med varning (‚ö†Ô∏é) - signal f√∂r gammal</div>
                  <div style={{ marginBottom: "4px" }}>‚ö†Ô∏è Edge Score &lt;50 - svag statistisk edge</div>
                  <div style={{ marginBottom: "4px" }}>‚ö†Ô∏è Status = üî¥ INVALIDATED - ta bort fr√•n listan</div>
                </div>
              </section>

              {/* Hur ber√§knas status */}
              <section style={{ marginBottom: "24px", background: "#fefce8", padding: "16px", borderRadius: "8px", border: "1px solid #fde047" }}>
                <h3 style={{ fontSize: "18px", fontWeight: "700", color: "#854d0e", marginBottom: "12px" }}>
                  üîç Hur ber√§knas Status? (Teknisk f√∂rklaring)
                </h3>
                <div style={{ fontSize: "13px", color: "#713f12" }}>
                  <p style={{ marginBottom: "12px" }}>Status √§r <strong>inte manuell</strong> ‚Äì den ber√§knas automatiskt fr√•n flera tekniska faktorer:</p>

                  <div style={{ marginBottom: "12px" }}>
                    <strong>Steg 1: Trend-check (h√•rd invalidering)</strong><br/>
                    Om <em>n√•gon</em> √§r sann ‚Üí üî¥ INVALIDATED:<br/>
                    ‚Ä¢ Pris &lt; EMA50<br/>
                    ‚Ä¢ EMA50 slope &lt; 0 (trenden pekar ned√•t)<br/>
                    ‚Ä¢ Ingen "higher low" (strukturen bruten)
                  </div>

                  <div style={{ marginBottom: "12px" }}>
                    <strong>Steg 2: Ber√§kna avst√•nd till EMA20</strong><br/>
                    <code style={{ background: "#fef3c7", padding: "2px 6px", borderRadius: "3px" }}>distEma20 = ((pris - ema20) / ema20) √ó 100</code><br/>
                    ‚Ä¢ FAR: &gt;4%<br/>
                    ‚Ä¢ APPROACHING: 2-4%<br/>
                    ‚Ä¢ NEAR: 0-2% (ovanf√∂r EMA20)<br/>
                    ‚Ä¢ TOO_DEEP: &lt;0% (under EMA20)
                  </div>

                  <div style={{ marginBottom: "12px" }}>
                    <strong>Steg 3: Statusmaskin</strong><br/>
                    ‚Ä¢ <strong>üü¢ READY</strong> = NEAR (0-2%) + RSI 40-55 (CALM) + OK volym<br/>
                    ‚Ä¢ <strong>üü° APPROACHING</strong> = APPROACHING (2-4%)<br/>
                    ‚Ä¢ <strong>üü† BREAKOUT_ONLY</strong> = RSI &gt;65 (f√∂r starkt momentum)<br/>
                    ‚Ä¢ <strong>üîµ WAIT_PULLBACK</strong> = FAR (&gt;4%) eller TOO_DEEP eller RSI &lt;40
                  </div>

                  <p style={{ fontSize: "12px", fontStyle: "italic", color: "#92400e" }}>
                    ‚Üí Status sammanfattar tekniken. De andra kolumnerna (EMA20 Œî%, RSI-zon, Edge Score) l√•ter dig verifiera och dubbelkolla.
                  </p>
                </div>
              </section>

              {/* Pro-tips */}
              <section style={{ marginBottom: "0" }}>
                <h3 style={{ fontSize: "18px", fontWeight: "700", color: "#0f172a", marginBottom: "12px", borderBottom: "2px solid #e2e8f0", paddingBottom: "8px" }}>
                  üí° Pro-tips
                </h3>
                <div style={{ fontSize: "13px", paddingLeft: "16px" }}>
                  <div style={{ marginBottom: "6px" }}><strong>Sortering:</strong> Listan sorterar automatiskt p√• status, s√• de b√§sta signalerna √§r h√∂gst upp!</div>
                  <div style={{ marginBottom: "6px" }}><strong>Breakout Alert:</strong> Om du ser "üéØ N√ÑRA!" under EMA20 Œî% = perfekt l√§ge att bevaka</div>
                  <div style={{ marginBottom: "6px" }}><strong>Daglig check:</strong> Tryck üîÑ Uppdatera varje morgon f√∂r fresh live-data</div>
                  <div style={{ marginBottom: "6px" }}><strong>Info-knapp:</strong> Klicka üîó f√∂r att √∂ppna aktien p√• Yahoo Finance</div>
                  <div style={{ marginBottom: "6px" }}><strong>Fokusera:</strong> Helst max 3-5 aktier i bevakningslistan samtidigt f√∂r b√§st fokus</div>
                </div>
              </section>
            </div>

            <div style={{ marginTop: "24px", paddingTop: "16px", borderTop: "1px solid #e2e8f0", textAlign: "right" }}>
              <button
                onClick={() => setShowHelpModal(false)}
                style={{
                  padding: "10px 24px",
                  background: "#0369a1",
                  color: "white",
                  border: "none",
                  borderRadius: "6px",
                  fontSize: "14px",
                  fontWeight: "600",
                  cursor: "pointer"
                }}
              >
                St√§ng
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
